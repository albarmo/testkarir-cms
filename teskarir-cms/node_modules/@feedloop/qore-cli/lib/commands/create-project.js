"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const command_1 = require("@oclif/command");
const simple_git_1 = tslib_1.__importDefault(require("simple-git"));
const user_1 = tslib_1.__importDefault(require("@feedloop/qore-sdk/lib/user"));
const fs_1 = tslib_1.__importDefault(require("fs"));
const fs_extra_1 = tslib_1.__importDefault(require("fs-extra"));
const path_1 = tslib_1.__importDefault(require("path"));
const config_1 = tslib_1.__importDefault(require("../config"));
const flags_1 = require("../flags");
const codegen_1 = tslib_1.__importDefault(require("./codegen"));
class CreateProject extends command_1.Command {
    static getTemplates() {
        const templates = fs_1.default
            .readdirSync(CreateProject.templatesLocation)
            .filter(file => fs_1.default
            .lstatSync(path_1.default.resolve(CreateProject.templatesLocation, file))
            .isDirectory());
        return templates;
    }
    async run() {
        var _a, _b;
        const { args, flags } = this.parse(CreateProject);
        const configs = await flags_1.promptFlags(flags, CreateProject.flags);
        const templates = CreateProject.getTemplates();
        const git = simple_git_1.default();
        const destination = path_1.default.resolve(process.cwd(), args.name || "qore-project");
        if (templates.indexOf(configs.template) === -1) {
            try {
                await git.clone(configs.template, destination);
                const packageJson = await fs_extra_1.default.readJson(path_1.default.resolve(destination, "package.json"));
                const isQoreProject = await fs_extra_1.default.pathExists(path_1.default.resolve(destination, ((_a = packageJson === null || packageJson === void 0 ? void 0 : packageJson.qoreconfig) === null || _a === void 0 ? void 0 : _a.path) || "", "qore.schema.json"));
                if (!isQoreProject) {
                    await fs_extra_1.default.unlink(destination);
                    throw new Error("Invalid template");
                }
            }
            catch (error) {
                this.error(`"${configs.template}" is not a valid template, please check if it is a qore project or choose from the following available templates: ${templates}`);
            }
        }
        else {
            fs_extra_1.default.copySync(path_1.default.resolve(CreateProject.templatesLocation, configs.template), destination);
        }
        const user = user_1.default();
        user.setToken(configs.token);
        const org = await user.organization(configs.org);
        const packageJson = await fs_extra_1.default.readJson(path_1.default.resolve(destination, "package.json"));
        const configPath = path_1.default.resolve(destination, ((_b = packageJson === null || packageJson === void 0 ? void 0 : packageJson.qoreconfig) === null || _b === void 0 ? void 0 : _b.path) || "");
        const schemaFile = fs_extra_1.default.readJSONSync(path_1.default.resolve(configPath, "qore.schema.json"));
        const projectId = await org.createProject({
            name: args.name,
            schema: schemaFile
        });
        config_1.default.set("org", org.id);
        config_1.default.set("project", projectId);
        await codegen_1.default.writeConfigFile(Object.assign(Object.assign({}, configs), { project: projectId }), configPath);
        this.log("New project initialized on", destination);
    }
}
exports.default = CreateProject;
CreateProject.description = "create a project from template";
CreateProject.examples = [
    `$ qore create-project --template todo-list-typescript your-project-name`
];
CreateProject.templatesLocation = path_1.default.resolve(__dirname, "../../templates/");
CreateProject.flags = {
    token: flags_1.tokenFlag,
    org: flags_1.orgFlag,
    template: command_1.flags.string({
        char: "t",
        name: "template",
        description: "qore project template",
        default: "todo-list-typescript"
    })
};
CreateProject.args = [{ name: "name" }];
